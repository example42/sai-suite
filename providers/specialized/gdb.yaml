# GDB Provider Data - GNU Debugger
version: "1.0"

provider:
  name: "gdb"
  display_name: "GNU Debugger"
  description: "Debug applications using GDB"
  type: "debug"
  platforms: ["linux", "macos"]
  capabilities: ["debug", "attach", "core_dump", "backtrace", "breakpoint", "watch", "inspect", "profile"]

actions:
  debug:
    description: "Start debugging session"
    template: "gdb {{saidata.commands.server.path}} {{debug_args}}"
    variables:
      debug_args: "--batch --ex run --ex bt --ex quit"

  attach:
    description: "Attach to running process"
    steps:
      - name: "find-process"
        command: "pgrep -f {{saidata.metadata.name}}"
      - name: "attach-debugger"
        command: "gdb -p $(pgrep -f {{saidata.metadata.name}}) {{attach_args}}"
    variables:
      attach_args: "--batch --ex bt --ex detach --ex quit"

  core_dump:
    description: "Analyze core dump"
    template: "gdb {{saidata.commands.server.path}} {{core_file}} {{core_args}}"
    variables:
      core_file: "/tmp/core.{{saidata.metadata.name}}"
      core_args: "--batch --ex bt --ex quit"

  backtrace:
    description: "Get stack trace from running process"
    template: "gdb -p $(pgrep -f {{saidata.metadata.name}}) --batch --ex bt --ex detach --ex quit"

  breakpoint:
    description: "Set breakpoint and debug"
    template: "gdb {{saidata.commands.server.path}} --batch --ex 'break {{breakpoint_location}}' --ex run --ex bt --ex quit"
    variables:
      breakpoint_location: "main"

  watch:
    description: "Watch variable changes"
    template: "gdb {{saidata.commands.server.path}} --batch --ex 'watch {{watch_variable}}' --ex run --ex continue --ex quit"
    variables:
      watch_variable: "global_var"

  inspect:
    description: "Inspect memory and variables"
    template: "gdb -p $(pgrep -f {{saidata.metadata.name}}) --batch --ex 'info registers' --ex 'info locals' --ex detach --ex quit"

  profile:
    description: "Profile application execution"
    template: "gdb {{saidata.commands.server.path}} --batch --ex 'set logging on' --ex run --ex bt --ex quit"

mappings:
  packages:
    server:
      name: "{{saidata.metadata.name}}"
      debug_symbols: "{{saidata.metadata.name}}-dbg"

  services:
    main:
      name: "{{saidata.metadata.name}}"
      type: "debug_target"

  files:
    config:
      path: "~/.gdbinit"
      owner: "$(whoami)"
      group: "$(whoami)"
      mode: "0644"
    log:
      path: "/tmp/gdb-{{saidata.metadata.name}}.log"
      owner: "$(whoami)"
      group: "$(whoami)"
      mode: "0644"

  directories:
    debug:
      path: "/tmp/debug-{{saidata.metadata.name}}"
      owner: "$(whoami)"
      group: "$(whoami)"
      mode: "0755"

  commands:
    server:
      path: "{{saidata.commands.server.path}}"
    debug:
      path: "gdb {{saidata.commands.server.path}}"

  ports:
    debug:
      port: "{{debug_port}}"
      configurable: true

  variables:
    "*":
      config_key: "{{variable_name}}"
    debug_port: "1234"
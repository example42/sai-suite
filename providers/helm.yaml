# Helm Provider Data - Kubernetes package manager
version: "1.0"

provider:
  name: "helm"
  display_name: "Helm"
  description: "The package manager for Kubernetes"
  type: "package_manager"
  platforms: ["linux", "macos", "windows"]
  capabilities: ["install", "uninstall", "upgrade", "search", "info", "list", "version", "start", "stop", "restart", "status", "logs"]

actions:
  install:
    description: "Install Helm chart"
    steps:
      - name: "add-repo"
        command: "helm repo add {{chart_repo}} {{saidata.urls.repository}}"
        ignore_failure: true
      - name: "update-repo"
        command: "helm repo update"
      - name: "install-chart"
        command: "helm install {{release_name}} {{chart_repo}}/{{sai_package(saidata, 'helm')}} --namespace {{namespace}} --create-namespace"
    timeout: 600
    validation:
      command: "helm list -n {{namespace}} | grep {{release_name}}"
      expected_exit_code: 0
    rollback: "helm uninstall {{release_name}} -n {{namespace}}"
    variables:
      release_name: "{{sai_package(saidata, 'helm')}}-release"
      namespace: "{{sai_package(saidata, 'helm')}}"
      chart_repo: "{{sai_package(saidata, 'helm')}}-repo"

  uninstall:
    description: "Remove Helm chart"
    template: "helm uninstall {{release_name}} -n {{namespace}}"
    detection: "helm search repo {{sai_package(saidata, 'helm')}} >/dev/null 2>&1"
    validation:
      command: "! helm list -n {{namespace}} | grep {{release_name}}"
      expected_exit_code: 0
    variables:
      release_name: "{{sai_package(saidata, 'helm')}}-release"
      namespace: "{{sai_package(saidata, 'helm')}}"

  upgrade:
    description: "Upgrade Helm chart"
    steps:
      - name: "update-repo"
        command: "helm repo update"
      - name: "upgrade-chart"
        command: "helm upgrade {{release_name}} {{chart_repo}}/{{sai_package(saidata, 'helm')}} -n {{namespace}}"
    timeout: 600
    detection: "helm search repo {{sai_package(saidata, 'helm')}} >/dev/null 2>&1"
    variables:
      release_name: "{{sai_package(saidata, 'helm')}}-release"
      namespace: "{{sai_package(saidata, 'helm')}}"
      chart_repo: "{{sai_package(saidata, 'helm')}}-repo"

  start:
    description: "Scale up Kubernetes deployment"
    template: "kubectl scale deployment {{sai_package(saidata, 'helm')}} --replicas=1 -n {{namespace}}"
    variables:
      namespace: "{{sai_package(saidata, 'helm')}}"

  stop:
    description: "Scale down Kubernetes deployment"
    template: "kubectl scale deployment {{sai_package(saidata, 'helm')}} --replicas=0 -n {{namespace}}"
    variables:
      namespace: "{{sai_package(saidata, 'helm')}}"

  restart:
    description: "Restart Kubernetes deployment"
    template: "kubectl rollout restart deployment/{{sai_package(saidata, 'helm')}} -n {{namespace}}"
    variables:
      namespace: "{{sai_package(saidata, 'helm')}}"

  status:
    description: "Check Helm release status"
    template: "helm status {{release_name}} -n {{namespace}}"
    variables:
      release_name: "{{sai_package(saidata, 'helm')}}-release"
      namespace: "{{sai_package(saidata, 'helm')}}"

  logs:
    description: "Show Kubernetes pod logs"
    template: "kubectl logs -l app={{sai_package(saidata, 'helm')}} -n {{namespace}} --tail=50"
    variables:
      namespace: "{{sai_package(saidata, 'helm')}}"

  info:
    description: "Show Helm chart information"
    template: "helm show chart {{chart_repo}}/{{sai_package(saidata, 'helm')}}"
    variables:
      chart_repo: "{{sai_package(saidata, 'helm')}}-repo"

  search:
    description: "Search for Helm charts"
    template: "helm search repo {{sai_package(saidata, 'helm')}}"

  list:
    description: "List Helm releases"
    template: "helm list -n {{namespace}} | grep {{sai_package(saidata, 'helm')}}"
    variables:
      namespace: "{{sai_package(saidata, 'helm')}}"

  version:
    description: "Show Helm release version"
    template: "helm list -n {{namespace}} -o json | jq '.[] | select(.name==\"{{release_name}}\") | .app_version'"
    variables:
      release_name: "{{sai_package(saidata, 'helm')}}-release"
      namespace: "{{sai_package(saidata, 'helm')}}"

# Binary Provider Data - Download and install pre-compiled binaries
version: "1.0"

provider:
  name: "binary"
  display_name: "Binary Download"
  description: "Download and install pre-compiled binary software"
  type: "binary"
  platforms: ["linux", "macos", "windows"]
  executable: "curl"  # Download utility for availability detection
  capabilities: ["install", "uninstall", "upgrade", "version", "info"]

actions:
  install:
    description: "Download and install binary"
    steps:
      - name: "create-temp-dir"
        command: "mkdir -p /tmp/sai-binary-install"
      - name: "download-binary"
        command: "cd /tmp/sai-binary-install && curl -L {{sai_binary(0, 'url', 'binary')}} -o binary.tar.gz"
      - name: "extract-archive"
        command: "cd /tmp/sai-binary-install && tar xzf binary.tar.gz"
        ignore_failure: true
      - name: "create-install-dir"
        command: "sudo mkdir -p {{sai_binary(0, 'install_path', 'binary')}}"
      - name: "install-binary"
        command: "sudo cp /tmp/sai-binary-install/{{sai_binary(0, 'executable', 'binary')}} {{sai_binary(0, 'install_path', 'binary')}}/{{sai_binary(0, 'executable', 'binary')}}"
      - name: "set-permissions"
        command: "sudo chmod {{sai_binary(0, 'permissions', 'binary')}} {{sai_binary(0, 'install_path', 'binary')}}/{{sai_binary(0, 'executable', 'binary')}}"
      - name: "cleanup-temp"
        command: "rm -rf /tmp/sai-binary-install"
        ignore_failure: true
    timeout: 600
    validation:
      command: "test -f {{sai_binary(0, 'install_path', 'binary')}}/{{sai_binary(0, 'executable', 'binary')}}"
      expected_exit_code: 0
    rollback: "sudo rm -f {{sai_binary(0, 'install_path', 'binary')}}/{{sai_binary(0, 'executable', 'binary')}}"

  uninstall:
    description: "Remove installed binary"
    steps:
      - name: "remove-binary"
        command: "sudo rm -f {{sai_binary(0, 'install_path', 'binary')}}/{{sai_binary(0, 'executable', 'binary')}}"
    validation:
      command: "! test -f {{sai_binary(0, 'install_path', 'binary')}}/{{sai_binary(0, 'executable', 'binary')}}"
      expected_exit_code: 0

  upgrade:
    description: "Upgrade installed binary"
    steps:
      - name: "backup-current"
        command: "sudo cp {{sai_binary(0, 'install_path', 'binary')}}/{{sai_binary(0, 'executable', 'binary')}} {{sai_binary(0, 'install_path', 'binary')}}/{{sai_binary(0, 'executable', 'binary')}}.backup"
        ignore_failure: true
      - name: "create-temp-dir"
        command: "mkdir -p /tmp/sai-binary-upgrade"
      - name: "download-new-binary"
        command: "cd /tmp/sai-binary-upgrade && curl -L {{sai_binary(0, 'url', 'binary')}} -o binary.tar.gz"
      - name: "extract-new-archive"
        command: "cd /tmp/sai-binary-upgrade && tar xzf binary.tar.gz"
        ignore_failure: true
      - name: "install-new-binary"
        command: "sudo cp /tmp/sai-binary-upgrade/{{sai_binary(0, 'executable', 'binary')}} {{sai_binary(0, 'install_path', 'binary')}}/{{sai_binary(0, 'executable', 'binary')}}"
      - name: "set-new-permissions"
        command: "sudo chmod {{sai_binary(0, 'permissions', 'binary')}} {{sai_binary(0, 'install_path', 'binary')}}/{{sai_binary(0, 'executable', 'binary')}}"
      - name: "cleanup-backup"
        command: "sudo rm -f {{sai_binary(0, 'install_path', 'binary')}}/{{sai_binary(0, 'executable', 'binary')}}.backup"
        ignore_failure: true
      - name: "cleanup-temp"
        command: "rm -rf /tmp/sai-binary-upgrade"
        ignore_failure: true
    timeout: 600
    validation:
      command: "test -f {{sai_binary(0, 'install_path', 'binary')}}/{{sai_binary(0, 'executable', 'binary')}}"
      expected_exit_code: 0
    rollback: "sudo mv {{sai_binary(0, 'install_path', 'binary')}}/{{sai_binary(0, 'executable', 'binary')}}.backup {{sai_binary(0, 'install_path', 'binary')}}/{{sai_binary(0, 'executable', 'binary')}}"

  version:
    description: "Show installed version"
    template: "echo 'Version: {{sai_binary(0, 'version', 'binary')}}'"

  info:
    description: "Show binary installation information"
    template: "echo 'Binary URL: {{sai_binary(0, 'url', 'binary')}}' && echo 'Install Path: {{sai_binary(0, 'install_path', 'binary')}}' && echo 'Executable: {{sai_binary(0, 'executable', 'binary')}}'"
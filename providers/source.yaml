# Source Provider Data - Build software from source code
version: "1.0"

provider:
  name: "source"
  display_name: "Source Build"
  description: "Build and install software from source code with multi-build system support"
  type: "source"
  platforms: ["linux", "macos", "windows"]
  executable: "make"  # Basic build tool for availability detection
  capabilities: ["install", "uninstall", "upgrade", "version", "info"]

actions:
  install:
    description: "Build and install from source"
    steps:
      - name: "create-build-dir"
        command: "mkdir -p {{sai_source(0, 'build_dir', 'source')}}"
      - name: "download-source"
        command: "cd {{sai_source(0, 'build_dir', 'source')}} && wget {{sai_source(0, 'url', 'source')}} -O source.tar.gz"
      - name: "extract-source"
        command: "cd {{sai_source(0, 'build_dir', 'source')}} && tar xzf source.tar.gz"
      - name: "configure"
        command: "cd {{sai_source(0, 'source_dir', 'source')}} && ./configure --prefix={{sai_source(0, 'install_prefix', 'source')}}"
        ignore_failure: true
      - name: "build"
        command: "cd {{sai_source(0, 'source_dir', 'source')}} && make"
      - name: "install"
        command: "cd {{sai_source(0, 'source_dir', 'source')}} && sudo make install"
    timeout: 3600
    validation:
      command: "test -d {{sai_source(0, 'install_prefix', 'source')}}"
      expected_exit_code: 0
    rollback: "cd {{sai_source(0, 'source_dir', 'source')}} && sudo make uninstall && rm -rf {{sai_source(0, 'build_dir', 'source')}}"

  uninstall:
    description: "Remove source-built software"
    steps:
      - name: "uninstall-files"
        command: "cd {{sai_source(0, 'source_dir', 'source')}} && sudo make uninstall"
        ignore_failure: true
      - name: "remove-build-dir"
        command: "rm -rf {{sai_source(0, 'build_dir', 'source')}}"
        ignore_failure: true
    validation:
      command: "! test -d {{sai_source(0, 'install_prefix', 'source')}}"
      expected_exit_code: 0

  upgrade:
    description: "Upgrade source-built software"
    steps:
      - name: "backup-source-dir"
        command: "cp -r {{sai_source(0, 'source_dir', 'source')}} {{sai_source(0, 'source_dir', 'source')}}.backup"
        ignore_failure: true
      - name: "download-new-source"
        command: "cd {{sai_source(0, 'build_dir', 'source')}} && wget {{sai_source(0, 'url', 'source')}} -O source-new.tar.gz"
      - name: "extract-new-source"
        command: "cd {{sai_source(0, 'build_dir', 'source')}} && tar xzf source-new.tar.gz"
      - name: "configure-new"
        command: "cd {{sai_source(0, 'source_dir', 'source')}} && ./configure --prefix={{sai_source(0, 'install_prefix', 'source')}}"
        ignore_failure: true
      - name: "build-new"
        command: "cd {{sai_source(0, 'source_dir', 'source')}} && make"
      - name: "install-new"
        command: "cd {{sai_source(0, 'source_dir', 'source')}} && sudo make install"
    timeout: 3600
    validation:
      command: "test -d {{sai_source(0, 'install_prefix', 'source')}}"
      expected_exit_code: 0
    rollback: "mv {{sai_source(0, 'source_dir', 'source')}}.backup {{sai_source(0, 'source_dir', 'source')}}"

  version:
    description: "Show source build version"
    template: "echo 'Version: {{sai_source(0, 'version', 'source')}}'"

  info:
    description: "Show source build information"
    template: "echo 'Build System: {{sai_source(0, 'build_system', 'source')}}' && echo 'Source URL: {{sai_source(0, 'url', 'source')}}' && echo 'Install Prefix: {{sai_source(0, 'install_prefix', 'source')}}'"